<?xml version="1.0" encoding="utf-8"?>
<test>

<name>knn prefiltering</name>

<requires>
	<knn/>
	<force-rt/>
	<http/>
</requires>

<skip_indexer/>

<config>
searchd
{
	<searchd_Settings/>
	data_dir = <data_path path="data0"/>
}
</config>

<queries>
<sphinxql>
	create table t_filter (title text, category int, vec float_vector knn_type='hnsw' knn_dims='4' hnsw_similarity='l2');
	insert into t_filter values 
		(1, 'doc1', 1, (0.1, 0.2, 0.3, 0.4)),
		(2, 'doc2', 2, (0.2, 0.3, 0.4, 0.5)),
		(3, 'doc3', 3, (0.3, 0.4, 0.5, 0.6)),
		(4, 'doc4', 1, (0.4, 0.5, 0.6, 0.7)),
		(5, 'doc5', 2, (0.5, 0.6, 0.7, 0.8)),
		(6, 'doc6', 3, (0.6, 0.7, 0.8, 0.9)),
		(7, 'doc7', 1, (0.7, 0.8, 0.9, 1.0)),
		(8, 'doc8', 2, (0.8, 0.9, 1.0, 1.1)),
		(9, 'doc9', 3, (0.9, 1.0, 1.1, 1.2)),
		(10, 'doc10', 1, (1.0, 1.1, 1.2, 1.3));
	flush ramchunk t_filter;

	select id, category, knn_dist() dist from t_filter where knn(vec, 2, (0.3, 0.4, 0.5, 0.6), {oversampling=1.0}) and category=1;
	select id, category, knn_dist() dist from t_filter where knn(vec, 2, (0.3, 0.4, 0.5, 0.6), {oversampling=1.0,fullscan=1}) and category=1;
	select id, category, knn_dist() dist from t_filter where knn(vec, 2, (0.3, 0.4, 0.5, 0.6), {oversampling=1.0,prefilter=1}) and category=1;

</sphinxql>

<!-- prefilter -->
<query endpoint="json/search">
{
	"table": "t_filter",
	"knn": {
		"k": 2,
		"field": "vec",
		"query": [0.3, 0.4, 0.5, 0.6],
		"oversampling": 1.0,
		"filter": {
			"bool": { "must": [ { "equals": { "category": 1 } } ] }
		}
	}
}
</query>

<!-- fullscan -->
<query endpoint="json/search">
{
	"table": "t_filter",
	"knn": {
		"k": 2,
		"field": "vec",
		"query": [0.3, 0.4, 0.5, 0.6],
		"oversampling": 1.0,
		"fullscan": true,
		"filter": {
			"bool": { "must": [ { "equals": { "category": 1 } } ] }
		}
	}
}
</query>

<!-- postfilter -->
<query endpoint="json/search">
{
	"table": "t_filter",
	"knn": {
		"k": 2,
		"field": "vec",
		"query": [0.3, 0.4, 0.5, 0.6],
		"oversampling": 1.0
	},
	"query":
	{
		"bool": { "must": [ { "equals": { "category": 1 } } ] }
	}
}
</query>

<sphinxql>
	create table t_price (title text, price float, vec float_vector knn_type='hnsw' knn_dims='4' hnsw_similarity='l2');
	insert into t_price values 
		(1, 'cheap1', 10.0, (0.1, 0.2, 0.3, 0.4)),
		(2, 'cheap2', 20.0, (0.2, 0.3, 0.4, 0.5)),
		(3, 'expensive1', 80.0, (0.8, 0.9, 1.0, 1.1)),
		(4, 'expensive2', 90.0, (0.9, 1.0, 1.1, 1.2)),
		(5, 'cheap3', 30.0, (0.3, 0.4, 0.5, 0.6)),
		(6, 'expensive3', 100.0, (1.0, 1.1, 1.2, 1.3));
	flush ramchunk t_price;

	select id, price, knn_dist() dist from t_price where knn(vec, 2, (0.2, 0.3, 0.4, 0.5), {oversampling=1.0}) and price&lt;50;
    select id, price, knn_dist() dist from t_price where knn(vec, 2, (0.2, 0.3, 0.4, 0.5), {oversampling=1.0, fullscan=1}) and price&lt;50;
	select id, price, knn_dist() dist from t_price where knn(vec, 2, (0.2, 0.3, 0.4, 0.5), {oversampling=1.0, prefilter=1}) and price&lt;50;

	select id, price, knn_dist() dist from t_price where knn(vec, 2, (0.48, 0.58, 0.68, 0.78), {oversampling=1.0}) and price=100;
	select id, price, knn_dist() dist from t_price where knn(vec, 2, (0.48, 0.58, 0.68, 0.78), {oversampling=1.0, fullscan=1}) and price=100;
	select id, price, knn_dist() dist from t_price where knn(vec, 2, (0.48, 0.58, 0.68, 0.78), {oversampling=1.0, prefilter=1}) and price=100;

	drop table t_price;
	drop table t_filter;

	<!-- prefiltering vs oversampling (3.0 by default) -->
	create table t_large (title text, category int, price float, vec float_vector knn_type='hnsw' knn_dims='4' hnsw_similarity='l2');
	insert into t_large values 
		(1, 'doc1', 1, 10.0, (0.05, 0.15, 0.25, 0.35)),
		(2, 'doc2', 2, 20.0, (0.10, 0.20, 0.30, 0.40)),
		(3, 'doc3', 3, 30.0, (0.15, 0.25, 0.35, 0.45)),
		(4, 'doc4', 1, 40.0, (0.20, 0.30, 0.40, 0.50)),
		(5, 'doc5', 2, 50.0, (0.25, 0.35, 0.45, 0.55)),
		(6, 'doc6', 3, 60.0, (0.30, 0.40, 0.50, 0.60)),
		(7, 'doc7', 1, 70.0, (0.35, 0.45, 0.55, 0.65)),
		(8, 'doc8', 2, 80.0, (0.40, 0.50, 0.60, 0.70)),
		(9, 'doc9', 3, 90.0, (0.45, 0.55, 0.65, 0.75)),
		(10, 'doc10', 1, 100.0, (0.50, 0.60, 0.70, 0.80)),
		(11, 'doc11', 2, 15.0, (0.55, 0.65, 0.75, 0.85)),
		(12, 'doc12', 3, 25.0, (0.60, 0.70, 0.80, 0.90)),
		(13, 'doc13', 1, 35.0, (0.65, 0.75, 0.85, 0.95)),
		(14, 'doc14', 2, 45.0, (0.70, 0.80, 0.90, 1.00)),
		(15, 'doc15', 3, 55.0, (0.75, 0.85, 0.95, 1.05)),
		(16, 'doc16', 1, 65.0, (0.80, 0.90, 1.00, 1.10)),
		(17, 'doc17', 2, 75.0, (0.85, 0.95, 1.05, 1.15)),
		(18, 'doc18', 3, 85.0, (0.90, 1.00, 1.10, 1.20)),
		(19, 'doc19', 1, 95.0, (0.95, 1.05, 1.15, 1.25)),
		(20, 'doc20', 2, 5.0, (1.00, 1.10, 1.20, 1.30)),
		(21, 'doc21', 3, 12.0, (0.12, 0.22, 0.32, 0.42)),
		(22, 'doc22', 1, 22.0, (0.22, 0.32, 0.42, 0.52)),
		(23, 'doc23', 2, 32.0, (0.32, 0.42, 0.52, 0.62)),
		(24, 'doc24', 3, 42.0, (0.42, 0.52, 0.62, 0.72)),
		(25, 'doc25', 1, 52.0, (0.52, 0.62, 0.72, 0.82));
	flush ramchunk t_large;

	select id, category, knn_dist() dist from t_large where knn(vec, 3, (0.15, 0.25, 0.35, 0.45)) and category=1;
	select id, category, knn_dist() dist from t_large where knn(vec, 3, (0.15, 0.25, 0.35, 0.45), {prefilter=1}) and category=1;

	select id, price, knn_dist() dist from t_large where knn(vec, 2, (0.25, 0.35, 0.45, 0.55)) and price&lt;30;
	select id, price, knn_dist() dist from t_large where knn(vec, 2, (0.25, 0.35, 0.45, 0.55), {prefilter=1}) and price&lt;30;

	drop table t_large;
</sphinxql>
</queries>

</test>